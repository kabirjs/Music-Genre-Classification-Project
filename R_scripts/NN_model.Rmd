---
title: "Neural Network Model - Music Genre Classification"
author: "Kabir Snell"
date: "2022-10-03"
output:
  html_document:
    df_print: paged
---

```{R message=FALSE}
# Loading Libraries
library(tidyverse)
library(tidymodels)
library(randomForest)
library(alr4)
library(caret)
library(keras)
library(tensorflow)
```

```{R}
# Reading in the data
genre <- read.csv('../data/processed/processed_data.csv', stringsAsFactors = TRUE)
```

```{R}
genre <- genre %>%
  select(-X)
```

```{R}
set.seed(727)

shuffle = genre[sample(1:nrow(genre)), ]
```

```{R}
# Splitting the data
set.seed(727)

genre_split <- initial_split(shuffle, prop = .8)

genre_train <- training(genre_split)
genre_test <- testing(genre_split)
```

```{R}
x_train <- genre_train %>%
  select(-c(music_genre, duration_ms)) %>%
  rowid_to_column("X") %>%
  mutate(key_seen = 1) %>%
  pivot_wider(names_from = key, values_from = key_seen, values_fill = 0) %>%
  mutate(mode_seen = 1) %>%
  pivot_wider(names_from = mode, values_from = mode_seen, values_fill = 0) %>%
  select(-c(X)) %>%
  as.matrix()

y_train <- genre_train %>%
  select(music_genre) %>%
  rowid_to_column("X") %>%
  mutate(seen = 1) %>%
  pivot_wider(names_from = music_genre, values_from = seen, values_fill = 0) %>%
  select(-X) %>%
  as.matrix()
```

```{R}
x_test <- genre_test %>%
  select(-c(music_genre, duration_ms)) %>%
  rowid_to_column("X") %>%
  mutate(key_seen = 1) %>%
  pivot_wider(names_from = key, values_from = key_seen, values_fill = 0) %>%
  mutate(mode_seen = 1) %>%
  pivot_wider(names_from = mode, values_from = mode_seen, values_fill = 0) %>%
  select(-c(X)) %>%
  as.matrix()

y_test <- genre_test %>%
  select(music_genre) %>%
  rowid_to_column("X") %>%
  mutate(seen = 1) %>%
  pivot_wider(names_from = music_genre, values_from = seen, values_fill = 0) %>%
  select(-X) %>%
  select(Alternative, Anime, Blues, Classical, Country, Electronic, 'Hip-Hop', Jazz, Rap, Rock) %>%
  as.matrix()
```

```{r}
model <- keras_model_sequential() %>%
  layer_dense(150, input_shape = ncol(x_train), activation = "relu") %>%
  layer_dense(25, activation = "relu") %>%
  layer_dense(10, activation = "softmax")

model %>%
  compile(
    loss = "categorical_crossentropy",
    optimizer = "adam",
    metrics = c("accuracy")
  )
```

```{r}
history <- model %>%
  fit(x = x_train,
      y = y_train,
      epochs = 100,
      batch_size = 200,
      validation_split = .2)
```

```{r}
summary(model)
evaluate(model, x_train, y_train)
```

```{R}
evaluate(model, x_test, y_test)
```





